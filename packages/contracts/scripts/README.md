# Automation Scripts

JavaScript scripts to automate configuration updates after contract deployment.

## Available Scripts

### 1. `update-config.js`

Automatically updates `Config.s.sol` with the latest deployed addresses.

**Usage:**

```bash
# Use with Base Sepolia (default)
node scripts/update-config.js

# Specify network and deploy script
node scripts/update-config.js [network] [deployScript]

# Examples
node scripts/update-config.js 84532 DeployFundingManager.s.sol
node scripts/update-config.js 31337 DeployFundingManager.s.sol
node scripts/update-config.js 8453 DeployFundingManager.s.sol
```

**Features:**

- ✅ Reads Foundry broadcast files
- ✅ Extracts deployed contract addresses
- ✅ Updates `Config.s.sol` automatically
- ✅ Supports multiple networks
- ✅ Validates addresses and provides checksumming
- ✅ Detailed logging with network information

### 2. `update-frontend-config.js`

Generates frontend configuration files (`contracts.ts` and `.env.local`) with deployed contract addresses.

**Usage:**

```bash
# Use with Base Sepolia (default)
node scripts/update-frontend-config.js

# Specify network and deploy script
node scripts/update-frontend-config.js [network] [deployScript]

# Examples
node scripts/update-frontend-config.js 84532 DeployFundingManager.s.sol
node scripts/update-frontend-config.js 31337 DeployFundingManager.s.sol
node scripts/update-frontend-config.js 8453 DeployFundingManager.s.sol
```

**Features:**

- ✅ Creates `contracts.ts` for frontend
- ✅ Creates `.env.local` with environment variables
- ✅ Supports multiple networks
- ✅ Generates RPC URLs and explorer links
- ✅ Validates addresses and provides checksumming
- ✅ Detailed logging with network information

## Supported Networks

| Network ID | Name             | Explorer                     | RPC URL                      |
| ---------- | ---------------- | ---------------------------- | ---------------------------- |
| 31337      | Local/Anvil      | http://localhost:8545        | http://localhost:8545        |
| 84532      | Base Sepolia     | https://sepolia.basescan.org | https://sepolia.base.org     |
| 8453       | Base Mainnet     | https://basescan.org         | https://mainnet.base.org     |
| 1          | Ethereum Mainnet | https://etherscan.io         | https://eth.llamarpc.com     |
| 11155111   | Sepolia          | https://sepolia.etherscan.io | https://sepolia.llamarpc.com |

## When to Run These Scripts

### ⚠️ Important: Run AFTER Deployment

These scripts should be run **after** you have successfully deployed contracts using Foundry. They read the broadcast files generated by `forge script --broadcast` and update configuration files automatically.

### Complete Workflow

### 1. Manual Setup (Before First Deployment)

**Edit these files manually before deploying:**

```bash
# Edit protocol wallet addresses
vim script/Config.s.sol

# Edit USDC addresses for your network (if needed)
vim script/DeployFundingManager.s.sol
```

### 2. Deploy Contracts

```bash
# Deploy on Base Sepolia
forge script script/DeployFundingManager.s.sol:DeployFundingManager \
  --rpc-url https://sepolia.base.org \
  --broadcast \
  --verify
```

### 3. Run Automation Scripts (After Deployment)

```bash
# Update Config.s.sol with deployed addresses
node scripts/update-config.js 84532

# Update frontend configuration
node scripts/update-frontend-config.js 84532
```

### 4. Verify Changes

```bash
# Verify that Config.s.sol was updated
cat script/Config.s.sol | grep "Base Sepolia"

# Verify that frontend files were created
ls -la ../frontend/config/contracts.ts
ls -la ../frontend/.env.local
```

## What These Scripts Do

### `update-config.js`

**Input:** Broadcast files from `forge script --broadcast`
**Output:** Updated `script/Config.s.sol`

**What it updates:**

- ✅ FundingManager contract addresses
- ✅ USDC addresses (if found in deployment)
- ❌ Protocol wallet addresses (you must edit these manually)

### `update-frontend-config.js`

**Input:** Broadcast files from `forge script --broadcast`
**Output:** Frontend configuration files

**What it creates:**

- ✅ `../frontend/config/contracts.ts` - Contract addresses
- ✅ `../frontend/.env.local` - Environment variables

## Generated Files

### `update-config.js` generates:

- Updates `script/Config.s.sol` with deployed addresses

### `update-frontend-config.js` generates:

- `../frontend/config/contracts.ts` - Contract configuration
- `../frontend/.env.local` - Environment variables

## Required Environment Variables

```bash
# For Foundry scripts
export PRIVATE_KEY="your_private_key"
export ETHERSCAN_API_KEY="your_api_key"

# For automation scripts (optional)
export RPC_URL="https://sepolia.base.org"
export EXPLORER_URL="https://sepolia.basescan.org"
```

## Directory Structure

```
packages/contracts/
├── scripts/                     # Automation scripts
│   ├── update-config.js         # Updates Config.s.sol
│   ├── update-frontend-config.js # Updates frontend
│   └── README.md               # This file
├── script/                     # Foundry deployment scripts
│   └── Config.s.sol            # Updated by update-config.js
├── broadcast/                  # Foundry broadcast files
│   └── DeployFundingManager.s.sol/
│       ├── 84532/             # Base Sepolia
│       ├── 8453/              # Base Mainnet
│       └── 31337/             # Local/Anvil
└── ../frontend/                # Frontend files (updated by scripts)
    ├── config/
    │   └── contracts.ts        # Generated by update-frontend-config.js
    └── .env.local              # Generated by update-frontend-config.js
```

## Troubleshooting

### Error: "No broadcast file found"

```bash
# Make sure you ran the deploy script with --broadcast
forge script script/DeployFundingManager.s.sol:DeployFundingManager \
  --rpc-url [RPC_URL] \
  --broadcast
```

### Error: "Unsupported network"

```bash
# Use a supported network or add the new network to the NETWORKS object
node scripts/update-config.js 84532  # Base Sepolia
node scripts/update-config.js 31337  # Local/Anvil
```

### Error: "Could not extract contract addresses"

```bash
# Verify that the broadcast file contains valid transactions
cat broadcast/DeployFundingManager.s.sol/84532/run-latest.json | jq '.transactions'
```

### Error: "Could not find address pattern"

```bash
# Check that the network is configured in Config.s.sol
grep -n "84532" script/Config.s.sol
```

## Examples

### Complete Deployment Workflow

```bash
# 1. Deploy contracts
forge script script/DeployFundingManager.s.sol:DeployFundingManager \
  --rpc-url https://sepolia.base.org \
  --broadcast \
  --verify

# 2. Update configuration
node scripts/update-config.js 84532
node scripts/update-frontend-config.js 84532

# 3. Verify updates
echo "Config.s.sol updated:"
grep -A 5 "Base Sepolia" script/Config.s.sol

echo "Frontend files created:"
ls -la ../frontend/config/contracts.ts ../frontend/.env.local
```

### Local Development

```bash
# 1. Start local node
anvil

# 2. Deploy contracts
forge script script/DeployFundingManager.s.sol:DeployFundingManager \
  --rpc-url http://localhost:8545 \
  --broadcast

# 3. Update configuration
node scripts/update-config.js 31337
node scripts/update-frontend-config.js 31337
```

## Contributing

When adding new networks or features:

1. Update the `NETWORKS` object in both scripts
2. Test with the new network
3. Update this README with the new network information
4. Ensure the network is supported in `Config.s.sol`

## License

This project is licensed under the MIT License - see the [LICENSE](../../LICENSE) file for details.
